<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PeaceOut ‚Äî Discover</title>
  <link rel="icon" type="image/svg+xml" href="../assets/branding/peaceout-logo-concept.svg" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    html, body { min-height: 100vh; margin: 0; font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #B8FFF9 0%, #FFDEE9 100%); color: #222;}
    .topbar, .site-nav { background: #fff; }
    .topbar { display: flex; align-items: center; justify-content: space-between; padding: 1.5em 2em 1.2em 2em; border-radius: 0 0 18px 18px; box-shadow: 0 2px 12px #40C9FF22; }
    .logo { width: 48px; margin-right: 1.1em; }
    .welcome { font-size: 1.4em; color: #005C97; font-weight: 800; }
    .theme-badge { display:inline-block; padding:0.2em 1em; border-radius:15px; background:#B8FFF9; color:#005C97; font-size:0.98em; margin-left:1em;}
    .site-nav { display: flex; align-items: center; gap: 1.2rem; background: #fff; padding: 0.7rem 2rem 0.3rem 2rem; box-shadow: 0 2px 12px #40C9FF11; margin-bottom: 1.2rem; border-radius: 0 0 16px 16px; }
    .site-nav a { color: #005C97; font-weight: 700; text-decoration: none; padding: 0.4rem 1.2rem; border-radius: 20px; transition: background 0.14s; }
    .site-nav a.active, .site-nav a:hover { background: #B8FFF9; color: #FF3CAC; }
    .discover-container { max-width: 900px; margin: 3em auto; background: #fff; border-radius: 16px; box-shadow: 0 6px 24px #40C9FF22; padding: 2em; }
    .search-bar { display: flex; gap:1em; align-items: center; margin-bottom: 2em; }
    .search-bar input { flex:1; padding:0.75em; font-size:1.1em; border-radius:12px; border:1.5px solid #40C9FF; }
    .tabs { margin-bottom:1.2em; }
    .tabs button { background: #B8FFF9; border:none; border-radius:18px; padding:0.5em 1.4em; font-weight:700; color:#005C97; margin-right:0.8em; cursor:pointer; }
    .tabs button.active { background: linear-gradient(90deg,#40C9FF 0%,#FF3CAC 100%); color:#fff; }
    .results { display: grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:1.6em; }
    .user-card, .video-card { background:#f8f8f9; border-radius:14px; box-shadow:0 2px 10px #40C9FF18; padding:1.1em; display:flex; align-items:center; gap:1.2em; cursor:pointer; transition:transform 0.13s, box-shadow 0.15s; }
    .user-card:hover, .video-card:hover { transform: scale(1.03) translateY(-2px); box-shadow: 0 10px 32px #FF3CAC33;}
    .user-card img, .video-card .video-thumb { width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid #40C9FF; }
    .user-info { flex:1; }
    .user-info .username { font-weight:800; color:#005C97; font-size:1.09em; }
    .user-info .bio { font-size:0.97em; color:#888; margin-top:0.3em; }
    .user-info .theme-badge { display:inline-block; padding:0.18em 0.95em; border-radius:15px; background:#B8FFF9; color:#005C97; font-size:0.95em; margin-left:0.5em;}
    .video-info { flex:1; }
    .video-title { font-weight:700; color:#005C97; font-size:1.07em; margin-bottom:0.3em; }
    .video-uploader { font-size:0.96em; color:#40C9FF; }
    @media (max-width:600px) { .discover-container{padding:1em;} .results{grid-template-columns:1fr;} }
  </style>
  <style id="themeOverride"></style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <img src="../assets/branding/peaceout-logo-concept.svg" class="logo" />
      <span class="welcome">Discover <span class="theme-badge" id="themeBadge"></span></span>
    </div>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>
  <nav class="site-nav">
    <a href="homepage.html"><img src="../assets/branding/peaceout-logo-concept.svg" />Home</a>
    <a href="upload.html">Upload</a>
    <a href="discover.html" class="active">Discover</a>
    <a href="about-us.html">About</a>
    <a href="faq.html">FAQ</a>
    <a href="contact.html">Contact</a>
    <a href="#" id="profileNav">Profile</a>
  </nav>
  <div class="discover-container">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search videos, users, etc.">
    </div>
    <div class="tabs">
      <button class="active" data-type="all">All</button>
      <button data-type="videos">Videos</button>
      <button data-type="users">Users</button>
    </div>
    <div class="results" id="results"></div>
  </div>
  <script>
    const API_BASE = "https://peaceout-backend.onrender.com/api/";
    let searchType = 'all';

    const THEME_OVERRIDES = {
      "peaceful": "",
      "energetic": `
        body{background:linear-gradient(135deg,#FFDEE9 0%,#B8FFF9 100%);}
        .topbar, .site-nav, .discover-container { background: #FFDEE9 !important; }
        .user-info .theme-badge{background:#FF3CAC;color:#fff;}
        .welcome, .site-nav a { color:#FF3CAC !important; }
      `,
      "classic": `
        body{background:#fff;}
        .topbar, .site-nav, .discover-container { background: #fafafa !important; }
        .user-info .theme-badge{background:#e0e0e0;color:#333;}
        .welcome, .site-nav a { color:#222 !important; }
      `,
      "night": `
        body{background:#1a2233;}
        .topbar, .site-nav, .discover-container { background: #222 !important; color:#B8FFF9; }
        .welcome, .site-nav a { color:#B8FFF9 !important; }
        .user-info .theme-badge{background:#222;color:#B8FFF9;}
      `
    };
    function setTheme(theme) {
      if (!theme) theme = "peaceful";
      document.getElementById('themeOverride').textContent = THEME_OVERRIDES[theme] || "";
      document.getElementById('themeBadge').textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
    }
    async function getCurrentUserAndSetTheme() {
      try {
        const res = await fetch(API_BASE + 'me', { credentials: 'include' });
        const data = await res.json();
        if (res.ok && data && data.username) {
          setTheme(data.theme);
          document.getElementById('profileNav').href = `profile.html?u=${encodeURIComponent(data.username)}`;
        } else {
          document.getElementById('profileNav').href = 'edit-profile.html';
        }
      } catch {
        document.getElementById('profileNav').href = 'edit-profile.html';
      }
    }
    getCurrentUserAndSetTheme();

    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        searchType = btn.getAttribute('data-type');
        doSearch();
      };
    });
    document.getElementById('searchInput').addEventListener('input', () => { doSearch(); });

    function videoThumbUrl(video) {
      return video.filename || 'https://placehold.co/640x360?text=Video';
    }
    function userAvatarUrl(user) {
      return user.avatarUrl || '../assets/branding/peaceout-logo-concept.svg';
    }

    async function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      if (!q) { document.getElementById('results').innerHTML = ''; return; }
      try {
        const res = await fetch(`${API_BASE}discover?q=${encodeURIComponent(q)}&type=${searchType}`, { credentials: 'include' });
        const data = await res.json();
        let html = '';
        if (searchType === 'all' || searchType === 'users') {
          (data.users || []).forEach(user => {
            html += `
              <div class="user-card" onclick="window.location.href='profile.html?u=${encodeURIComponent(user.username)}'">
                <img src="${userAvatarUrl(user)}" alt="${user.username}">
                <div class="user-info">
                  <div class="username">${user.displayName || user.username}
                    <span class="theme-badge">${user.theme ? user.theme.charAt(0).toUpperCase()+user.theme.slice(1) : "Peaceful"}</span>
                  </div>
                  <div class="bio">${user.bio||''}</div>
                </div>
              </div>
            `;
          });
        }
        if (searchType === 'all' || searchType === 'videos') {
          (data.videos || []).forEach(video => {
            html += `
              <div class="video-card" onclick="window.location.href='profile.html?u=${encodeURIComponent(video.uploaderUsername)}'">
                <img class="video-thumb" src="${videoThumbUrl(video)}" alt="${video.title}">
                <div class="video-info">
                  <div class="video-title">${video.title}</div>
                  <div class="video-uploader">@${video.uploaderUsername}</div>
                  <div class="video-stats">
                    <span class="stat">üëç ${video.likes||0}</span>
                    <span class="stat">üëé ${video.dislikes||0}</span>
                    <span class="stat">üëÅÔ∏è ${video.views||0}</span>
                  </div>
                </div>
              </div>
            `;
          });
        }
        document.getElementById('results').innerHTML = html || '<div>No results found.</div>';
      } catch {
        document.getElementById('results').innerHTML = '<div style="color:#FF3CAC;">Search failed. Try again later.</div>';
      }
    }
    document.getElementById('logoutBtn').onclick = async function() {
      try {
        await fetch(API_BASE + 'logout', { method: 'POST', credentials: 'include' });
      } finally {
        window.location.href = 'auth.html';
      }
    }
  </script>
</body>
</html>