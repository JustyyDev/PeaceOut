<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PeaceOut â€” Login or Register</title>
  <link rel="icon" type="image/svg+xml" href="shared/branding/peaceout-logo-concept.svg" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    html, body {
      background: linear-gradient(135deg,#B8FFF9 0%,#FFDEE9 100%);
      font-family: 'Inter', sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 410px;
      margin: 4rem auto;
      background:#fff;
      border-radius: 24px;
      box-shadow: 0 6px 24px #40C9FF33;
      padding: 2.3rem 2rem 2rem 2rem;
    }
    .logo {
      width: 60px;
      display: block;
      margin: 0 auto 1.2rem;
    }
    h1 {
      text-align: center;
      color: #005C97;
      font-size: 2.1rem;
      margin-bottom: 1.4rem;
    }
    label {
      display: block;
      font-weight: 700;
      color: #40C9FF;
      margin:1.1rem 0 0.3rem;
    }
    input {
      width: 100%;
      border: 1.5px solid #40C9FF;
      border-radius: 12px;
      padding: 0.8rem;
      font-size: 1rem;
      margin-bottom: 0.7rem;
    }
    button {
      width: 100%;
      background: linear-gradient(90deg, #40C9FF 0%, #FF3CAC 100%);
      color: #fff;
      border:none;
      border-radius: 22px;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 0.8rem 0;
      cursor:pointer;
      margin-top: 1.2rem;
    }
    button:hover {
      box-shadow: 0 6px 24px #FF3CAC33;
    }
    .msg {
      color: #FF3CAC;
      font-size:1.05rem;
      text-align: center;
      min-height: 1.5em;
      margin: 0.5em 0 0.7em 0;
    }
    .success { color: #40C9FF; }
    .switch {
      text-align:center;
      margin-top:1.1em;
    }
    .switch a {
      color:#40C9FF;
      text-decoration:underline;
      cursor:pointer;
      font-weight:700;
    }
    .fadein {
      animation: fadein 0.3s;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(18px);}
      to { opacity: 1; transform: translateY(0);}
    }
    @media (max-width: 600px) { .container {padding:1.1rem 0.5rem;} }
  </style>
</head>
<body>
  <div class="container">
    <img src="shared/branding/peaceout-logo-concept.svg" alt="PeaceOut Logo" class="logo" />
    <div id="authForms"></div>
  </div>
  <script src="shared/js/api-config.js"></script>
  <script>
    const API_BASE = ApiConfig.BASE_URL;

    // Check session and redirect if already logged in
    async function checkSession() {
      try {
        const res = await ApiConfig.get('me');
        if (res.ok) {
          window.location.href = 'homepage.html';
        }
      } catch {}
    }

    function setMsg(msg, isSuccess) {
      const msgDiv = document.getElementById('authMsg');
      if (msgDiv) {
        msgDiv.textContent = msg || '';
        msgDiv.className = 'msg' + (isSuccess ? ' success' : '');
      }
    }

    function showLoginForm() {
      document.getElementById('authForms').innerHTML = `
        <h1>Sign In</h1>
        <form id="loginForm" autocomplete="off" class="fadein">
          <label for="loginUsername">Username</label>
          <input type="text" id="loginUsername" required autocomplete="username" maxlength="32" />
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" required autocomplete="current-password" />
          <div class="msg" id="authMsg"></div>
          <button type="submit">Login</button>
        </form>
        <div class="switch">
          Don't have an account? <a id="registerLink" tabindex="0">Register here</a>
        </div>
      `;
      document.getElementById('loginForm').onsubmit = async function(e) {
        e.preventDefault();
        setMsg('');
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!username || !password) return setMsg('Please enter username and password.');
        try {
          const res = await ApiConfig.post('login', { username, password });
          const data = await res.json();
          if (res.ok) {
            setMsg('Login successful! Redirecting...', true);
            setTimeout(() => window.location.href = 'homepage.html', 800);
          } else {
            setMsg(data.error || 'Login failed.');
          }
        } catch {
          setMsg('Network error. Please try again.');
        }
      };
      document.getElementById('registerLink').onclick = showRegisterForm;
    }

    function showRegisterForm() {
      document.getElementById('authForms').innerHTML = `
        <h1>Register</h1>
        <form id="registerForm" autocomplete="off" class="fadein">
          <label for="registerUsername">Username</label>
          <input type="text" id="registerUsername" required autocomplete="username" maxlength="32" />
          <label for="registerPassword">Password</label>
          <input type="password" id="registerPassword" required autocomplete="new-password" />
          <label for="registerPasswordRepeat">Repeat Password</label>
          <input type="password" id="registerPasswordRepeat" required autocomplete="new-password" />
          <div class="msg" id="authMsg"></div>
          <button type="submit">Register</button>
        </form>
        <div class="switch">
          Already have an account? <a id="loginLink" tabindex="0">Sign in</a>
        </div>
      `;
      document.getElementById('registerForm').onsubmit = async function(e) {
        e.preventDefault();
        setMsg('');
        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value;
        const passwordRepeat = document.getElementById('registerPasswordRepeat').value;
        if (!username || !password || !passwordRepeat) {
          setMsg('All fields are required.');
          return;
        }
        if (password !== passwordRepeat) {
          setMsg('Passwords do not match!');
          return;
        }
        if (password.length < 4) {
          setMsg('Password must be at least 4 characters.');
          return;
        }
        try {
          const res = await ApiConfig.post('register', { username, password, passwordRepeat });
          const data = await res.json();
          if (res.ok) {
            setMsg('Registration successful! Logging you in...', true);
            setTimeout(() => window.location.href = 'homepage.html', 800);
          } else {
            setMsg(data.error || 'Registration failed.');
          }
        } catch {
          setMsg('Network error. Please try again.');
        }
      };
      document.getElementById('loginLink').onclick = showLoginForm;
    }

    document.addEventListener('DOMContentLoaded', function() {
      checkSession();
      showLoginForm();
    });
  </script>
</body>
</html>