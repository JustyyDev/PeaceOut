<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Edit Profile â€” PeaceOut</title>
  <link rel="icon" type="image/svg+xml" href="shared/branding/peaceout-logo-concept.svg" />
  <style>
    body { background: linear-gradient(135deg,#B8FFF9 0%,#FFDEE9 100%); font-family: 'Inter', sans-serif; margin: 0; min-height: 100vh; }
    .container { max-width: 400px; margin: 3em auto; background: #fff; border-radius: 16px; box-shadow: 0 6px 24px #40C9FF22; padding: 2em; }
    h1 { color: #005C97; text-align: center; }
    label { display: block; margin-top: 1.5em; color: #005C97; font-weight: 700; }
    input, textarea, select { width: 100%; margin-top: 0.3em; padding: 0.7em; border-radius: 10px; border: 1.5px solid #40C9FF; font-size: 1em; }
    button { margin-top: 2em; width: 100%; background: linear-gradient(90deg,#40C9FF 0%,#FF3CAC 100%); color: #fff; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 700; padding: 0.9em; cursor: pointer; transition: background 0.12s; }
    button:hover { background: #FF3CAC; }
    .avatar-preview { display: flex; flex-direction: column; align-items: center; margin-top: 1.2em; }
    .avatar-preview img { width: 92px; height: 92px; border-radius: 50%; border: 2px solid #40C9FF; margin-bottom: 0.5em; object-fit: cover; }
    .error { color: #FF3CAC; margin-top: 1em; text-align: center; }
    .success { color: #05A660; margin-top: 1em; text-align: center; }
    .theme-preview { margin-top: 0.7em; display: flex; gap: 0.7em; flex-wrap: wrap;}
    .theme-badge { padding:0.2em 1em; border-radius:15px; background:#B8FFF9; color:#005C97; font-size:0.98em; border:2px solid #40C9FF; cursor:pointer;}
    .theme-badge.selected { background: #40C9FF; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Edit Profile</h1>
    <form id="profileForm">
      <div class="avatar-preview">
        <img id="avatarImg" src="shared/branding/peaceout-logo-concept.svg" alt="Current Avatar">
        <input type="file" id="avatarFile" accept="image/png,image/jpeg,image/jpg,image/gif" style="margin:0.5em 0;">
      </div>
      <label for="avatarUrl">Or avatar URL</label>
      <input id="avatarUrl" type="url" placeholder="https://... (optional)">
      <label for="displayName">Display Name</label>
      <input id="displayName" type="text" maxlength="50" placeholder="Display name (shown on your profile)">
      <label for="bio">Bio</label>
      <textarea id="bio" maxlength="256" rows="3" placeholder="Write a short bio..."></textarea>
      <label for="theme">Profile Theme</label>
      <div class="theme-preview" id="themePreview"></div>
      <select id="theme" style="margin-top:0.6em;">
        <!-- Populated by JS -->
      </select>
      <button type="submit">Update Profile</button>
      <div class="error" id="errorMsg"></div>
      <div class="success" id="successMsg"></div>
    </form>
  </div>
  <script>
    const API_BASE = "https://peaceout-backend.onrender.com/api/";
    let user = null;
    let themes = [];

    async function fetchUser() {
      try {
        const res = await fetch(`${API_BASE}me`, { credentials: 'include' });
        if (!res.ok) throw new Error('Not logged in');
        user = await res.json();
        document.getElementById('bio').value = user.bio || '';
        document.getElementById('avatarImg').src = user.avatarUrl || "shared/branding/peaceout-logo-concept.svg";
        document.getElementById('avatarUrl').value = user.avatarUrl || '';
        document.getElementById('displayName').value = user.displayName || '';
        document.getElementById('theme').value = user.theme || '';
        setTimeout(()=>{ // In case select not loaded yet
          document.getElementById('theme').value = user.theme || '';
          highlightTheme(user.theme || '');
        }, 300);
      } catch (e) {
        document.getElementById('errorMsg').textContent = "You must be logged in.";
      }
    }

    // Load theme choices and preview
    async function fetchThemes() {
      const res = await fetch(`${API_BASE}profile-themes`);
      themes = await res.json();
      let html = '';
      let options = '';
      themes.forEach(th => {
        html += `<span class="theme-badge" data-id="${th.id}">${th.name}</span>`;
        options += `<option value="${th.id}">${th.name}</option>`;
      });
      document.getElementById('themePreview').innerHTML = html;
      document.getElementById('theme').innerHTML = `<option value="">(Default)</option>` + options;
      document.querySelectorAll('.theme-badge').forEach(el => {
        el.onclick = () => {
          document.getElementById('theme').value = el.getAttribute('data-id');
          highlightTheme(el.getAttribute('data-id'));
        };
      });
    }
    function highlightTheme(id) {
      document.querySelectorAll('.theme-badge').forEach(el => el.classList.toggle('selected', el.getAttribute('data-id') === id));
      document.getElementById('theme').value = id;
    }
    fetchThemes();
    fetchUser();

    // Avatar preview
    document.getElementById('avatarFile').addEventListener('change', function() {
      const file = this.files[0];
      if (!file) return;
      if (!/^image\/(png|jpeg|jpg|gif)$/i.test(file.type)) {
        document.getElementById('errorMsg').textContent = "Only PNG, JPG, JPEG, GIF allowed.";
        this.value = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById('avatarImg').src = e.target.result;
      };
      reader.readAsDataURL(file);
      document.getElementById('errorMsg').textContent = "";
    });

    // Upload avatar image to backend
    async function uploadAvatarImage(file) {
      const formData = new FormData();
      formData.append("avatar", file);
      const res = await fetch(`${API_BASE}avatar/upload`, {
        method: "POST",
        credentials: "include",
        body: formData
      });
      if (!res.ok) throw new Error("Upload failed");
      const data = await res.json();
      return data.url;
    }

    document.getElementById('profileForm').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('errorMsg').textContent = "";
      document.getElementById('successMsg').textContent = "";
      let avatarUrl = document.getElementById('avatarUrl').value.trim();
      const bio = document.getElementById('bio').value.trim();
      const displayName = document.getElementById('displayName').value.trim();
      const theme = document.getElementById('theme').value;
      const fileInput = document.getElementById('avatarFile');
      if (fileInput.files[0]) {
        try {
          avatarUrl = await uploadAvatarImage(fileInput.files[0]);
        } catch (err) {
          document.getElementById('errorMsg').textContent = "Avatar upload failed.";
          return;
        }
      }
      // Fallback to dicebear if nothing provided
      if (!avatarUrl) avatarUrl = user ? user.avatarUrl : "";
      fetch(`${API_BASE}me`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ avatarUrl, bio, displayName, theme })
      }).then(async (res) => {
        if (!res.ok) {
          document.getElementById('errorMsg').textContent = "Failed to update profile.";
        } else {
          document.getElementById('successMsg').textContent = "Profile updated!";
          setTimeout(()=>location.reload(), 1200);
        }
      });
    };
  </script>
</body>
</html>