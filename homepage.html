<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PeaceOut ‚Äî Home</title>
  <link rel="icon" type="image/svg+xml" href="shared/branding/peaceout-logo-concept.svg" />
  <style id="themeStyle">
    /* --- PeaceOut base styles (keep this for energy) --- */
    html, body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #B8FFF9 0%, #FFDEE9 100%);
      color: #222;
    }
    .topbar {
      background: #fff;
      padding: 1.5em 2em 1.2em 2em;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 2px 12px #40C9FF22;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      width: 48px;
      margin-right: 1.1em;
    }
    .welcome {
      font-size: 1.4em;
      color: #005C97;
      font-weight: 800;
    }
    .logout-btn {
      background:linear-gradient(90deg,#FF3CAC 0%,#40C9FF 100%);
      color: #fff;
      border: none;
      border-radius: 18px;
      padding: 0.6em 1.3em;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      margin-left: 1.2em;
    }
    .site-nav {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      background: #fff;
      padding: 0.7rem 2rem 0.3rem 2rem;
      box-shadow: 0 2px 12px #40C9FF11;
      margin-bottom: 1.2rem;
      border-radius: 0 0 16px 16px;
    }
    .site-nav a {
      color: #005C97;
      font-weight: 700;
      text-decoration: none;
      padding: 0.4rem 1.2rem;
      border-radius: 20px;
      transition: background 0.14s;
    }
    .site-nav a.active, .site-nav a:hover { background: #B8FFF9; color: #FF3CAC; }
    .site-nav img { width: 30px; vertical-align: middle; margin-right: 0.5rem; }
    .main-content {
      max-width: 1100px;
      margin: 3em auto 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 24px #40C9FF22;
      padding: 2.3em 2em 2em 2em;
      min-height: 300px;
    }
    .hero-banner {
      background: linear-gradient(90deg, #40C9FF11 0%, #FF3CAC11 100%);
      border-radius: 14px;
      padding: 2em 1.5em 2em 1.5em;
      box-shadow: 0 1px 8px #40C9FF11;
      margin-bottom: 2em;
      text-align: center;
    }
    .hero-title {
      font-size: 2rem;
      font-weight: 900;
      color: #005C97;
      margin-bottom: 0.4em;
    }
    .hero-sub {
      color: #FF3CAC;
      font-size: 1.15em;
      font-weight: 700;
      margin-bottom: 1em;
    }
    .go-live-btn {
      background:linear-gradient(90deg,#40C9FF 0%,#FF3CAC 100%);
      color:#fff;
      border:none;
      border-radius:30px;
      font-size:1.12em;
      font-weight:800;
      padding:0.7em 2.2em;
      cursor:pointer;
      margin-top:1.2em;
      box-shadow:0 2px 12px #FF3CAC22;
      transition:box-shadow 0.13s, transform 0.13s;
    }
    .go-live-btn:hover { box-shadow:0 8px 32px #40C9FF22; transform:translateY(-2px) scale(1.02);}
    .search-bar {
      margin: 0 auto 2em auto;
      max-width: 500px;
      display: flex;
      gap: 0.7em;
      align-items: center;
    }
    .search-bar input[type="text"] {
      flex: 1;
      padding: 0.75em 1em;
      font-size: 1.08em;
      border-radius: 14px;
      border: 1.5px solid #40C9FF;
      outline: none;
      transition: border 0.15s;
    }
    .search-bar button {
      background: linear-gradient(90deg, #40C9FF 0%, #FF3CAC 100%);
      color: #fff;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      font-size: 1em;
      padding: 0.7em 1.5em;
      cursor: pointer;
    }
    .search-results { margin-top: 1em; margin-bottom: 2em; min-height: 2em; }
    .section-title {
      font-size: 1.35em;
      font-weight: 900;
      color: #005C97;
      margin-top: 2.5em;
      margin-bottom: 0.7em;
      text-align: left;
    }
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }
    .video-card {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 4px 16px #40C9FF22;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.13s, box-shadow 0.15s;
    }
    .video-card:hover {
      transform: scale(1.03) translateY(-2px);
      box-shadow: 0 10px 32px #FF3CAC33;
    }
    .video-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: #B8FFF9; }
    .video-info { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; }
    .uploader-avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #FF3CAC; object-fit: cover; }
    .video-meta { display: flex; flex-direction: column; gap: 0.15rem; flex: 1; min-width: 0; }
    .video-title { font-size: 1.08rem; font-weight: 700; color: #005C97; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .video-uploader { font-size: 0.98rem; color: #40C9FF; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-card {
      background:#f8f8f9;
      border-radius:14px;
      box-shadow:0 2px 10px #40C9FF18;
      padding:1.1em;
      display:flex;
      align-items:center;
      gap:1.2em;
      margin-bottom: 1em;
    }
    .user-card img {
      width:42px;
      height:42px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid #40C9FF;
    }
    .user-info { flex:1; }
    .user-info .username { font-weight:800; color:#005C97; font-size:1.09em; }
    .user-info .bio { font-size:0.97em; color:#888; margin-top:0.3em; }
    .theme-badge { display:inline-block; padding:0.2em 1em; border-radius:15px; background:#B8FFF9; color:#005C97; font-size:0.98em; margin-left:1em;}
    @media (max-width: 700px) {
      .videos-grid { grid-template-columns: 1fr; }
      .main-content { margin-top: 1rem; padding: 1.2em 0.3em; }
      .topbar { padding: 1em 0.6em 1em 0.6em; }
      .search-bar { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <img src="shared/branding/peaceout-logo-concept.svg" class="logo" />
      <span class="welcome">Welcome, <span id="username">...</span><span class="theme-badge" id="themeBadge"></span></span>
    </div>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>
  <nav class="site-nav">
    <a href="homepage.html"><img src="shared/branding/peaceout-logo-concept.svg" />Home</a>
    <a href="upload.html">Upload</a>
    <a href="discover.html" class="active">Discover</a>
    <a href="about-us.html">About</a>
    <a href="faq.html">FAQ</a>
    <a href="contact.html">Contact</a>
    <a href="#" id="profileNav">Profile</a>
  </nav>
  <div class="discover-container">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search videos, users, etc.">
    </div>
    <div class="tabs">
      <button class="active" data-type="all">All</button>
      <button data-type="videos">Videos</button>
      <button data-type="users">Users</button>
    </div>
    <div class="results" id="results"></div>
  </div>
  <script>
    const API_BASE = "https://peaceout-backend.onrender.com/api/";
    let searchType = 'all';

    // Theme handling
    const THEMES = {
      "peaceful": `body{background:linear-gradient(135deg,#B8FFF9 0%,#FFDEE9 100%);} .theme-badge{background:#B8FFF9;color:#005C97;}`,
      "energetic": `body{background:linear-gradient(135deg,#FFDEE9 0%,#B8FFF9 100%);}
        .topbar, .site-nav, .discover-container { background: #FFDEE9 !important; }
        .theme-badge{background:#FF3CAC;color:#fff;}
        .welcome, .site-nav a { color:#FF3CAC !important; }`,
      "classic": `body{background:#fff;}
        .topbar, .site-nav, .discover-container { background: #fafafa !important; }
        .theme-badge{background:#e0e0e0;color:#333;}
        .welcome, .site-nav a { color:#222 !important; }`,
      "night": `body{background:#1a2233;}
        .topbar, .site-nav, .discover-container { background: #222 !important; color:#B8FFF9; }
        .welcome, .site-nav a { color:#B8FFF9 !important; }
        .theme-badge{background:#222;color:#B8FFF9;}`
    };
    function setTheme(theme) {
      if (!theme) theme = "peaceful";
      let style = THEMES[theme] || THEMES["peaceful"];
      document.getElementById('themeStyle').textContent = style;
      document.getElementById('themeBadge').textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
    }
    // Get current user and set nav/profile theme
    async function getCurrentUserAndSetTheme() {
      try {
        const res = await fetch(API_BASE + 'me', { credentials: 'include' });
        const data = await res.json();
        if (res.ok && data && data.username) {
          setTheme(data.theme);
          document.getElementById('profileNav').href = `profile.html?u=${encodeURIComponent(data.username)}`;
          document.getElementById('username').textContent = data.displayName || data.username;
        } else {
          document.getElementById('profileNav').href = 'edit-profile.html';
        }
      } catch {
        document.getElementById('profileNav').href = 'edit-profile.html';
      }
    }
    getCurrentUserAndSetTheme();

    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        searchType = btn.getAttribute('data-type');
        doSearch();
      };
    });
    document.getElementById('searchInput').addEventListener('input', () => { doSearch(); });

    function videoThumbUrl(video) {
      return video.filename || 'https://placehold.co/640x360?text=Video';
    }
    function userAvatarUrl(user) {
      return user.avatarUrl || 'shared/branding/peaceout-logo-concept.svg';
    }

    async function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      if (!q) { document.getElementById('results').innerHTML = ''; return; }
      try {
        const res = await fetch(`${API_BASE}discover?q=${encodeURIComponent(q)}&type=${searchType}`, { credentials: 'include' });
        const data = await res.json();
        let html = '';
        if (searchType === 'all' || searchType === 'users') {
          (data.users || []).forEach(user => {
            html += `
              <div class="user-card" onclick="window.location.href='profile.html?u=${encodeURIComponent(user.username)}'">
                <img src="${userAvatarUrl(user)}" alt="${user.username}">
                <div class="user-info">
                  <div class="username">${user.displayName || user.username}
                    <span class="theme-badge">${user.theme ? user.theme.charAt(0).toUpperCase()+user.theme.slice(1) : "Peaceful"}</span>
                  </div>
                  <div class="bio">${user.bio||''}</div>
                </div>
              </div>
            `;
          });
        }
        if (searchType === 'all' || searchType === 'videos') {
          (data.videos || []).forEach(video => {
            html += `
              <div class="video-card" data-video='${JSON.stringify(video).replace(/'/g,"&apos;")}'>
                <img class="video-thumb" src="${videoThumbUrl(video)}" alt="${video.title}">
                <div class="video-info">
                  <div class="video-title">${video.title}</div>
                  <div class="video-uploader" onclick="window.location.href='profile.html?u=${encodeURIComponent(video.uploaderUsername)}'; event.stopPropagation();">@${video.uploaderUsername}</div>
                  <div class="video-stats">
                    <span class="stat">üëç ${video.likes||0}</span>
                    <span class="stat">üëé ${video.dislikes||0}</span>
                    <span class="stat">üëÅÔ∏è ${video.views||0}</span>
                  </div>
                </div>
              </div>
            `;
          });
        }
        document.getElementById('results').innerHTML = html || '<div>No results found.</div>';
        attachVideoClickHandlers();
      } catch {
        document.getElementById('results').innerHTML = '<div style="color:#FF3CAC;">Search failed. Try again later.</div>';
      }
    }

    function attachVideoClickHandlers() {
      document.querySelectorAll('.video-card').forEach(card => {
        card.onclick = function(e) {
          // Don't trigger modal on uploader click
          if (e.target.classList.contains('video-uploader')) return;
          const video = JSON.parse(card.getAttribute('data-video').replace(/&apos;/g, "'"));
          openVideoModal(video);
        };
      });
    }

    function formatTime(t) {
      if (isNaN(t)) return "00:00";
      const m = Math.floor(t/60), s = Math.floor(t%60);
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    async function openVideoModal(video) {
      const modal = document.getElementById('videoModal');
      modal.innerHTML = `
        <div class="modal-bg" onclick="if(event.target===this)closeVideoModal()">
          <div class="modal-content">
            <button class="modal-close" onclick="closeVideoModal()">&times;</button>
            <div class="custom-video-wrapper" id="customVideoWrap">
              <video id="customVideo" class="custom-video" src="${video.filename}" tabindex="0" controls></video>
              <div id="videoErrorUI" class="video-error-ui" style="display:none;">
                <div class="icon">üìÑ</div>
                <div>No video with supported format and MIME type found.</div>
              </div>
            </div>
            <div class="custom-controls" id="customControls" style="display:none;">
              <button id="playPauseBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
              <input id="seekBar" type="range" min="0" value="0" step="0.01">
              <span class="custom-time" id="currentTime">00:00</span>/<span class="custom-time" id="duration">00:00</span>
              <button id="muteBtn" title="Mute/Unmute">üîä</button>
            </div>
            <div class="video-title">${video.title}</div>
            <div class="video-uploader" style="cursor:pointer;" onclick="window.location.href='profile.html?u=${encodeURIComponent(video.uploaderUsername)}'">@${video.uploaderUsername}</div>
            <div class="video-stats" id="modalStats">
              <button class="like-btn" id="likeBtn">üëç</button>
              <span class="stat" id="likeCount">${video.likes||0}</span>
              <button class="dislike-btn" id="dislikeBtn">üëé</button>
              <span class="stat" id="dislikeCount">${video.dislikes||0}</span>
              <span class="stat"><span id="viewCount">${video.views||0}</span> üëÅÔ∏è</span>
            </div>
          </div>
        </div>
      `;
      modal.style.display = 'block';
      setupCustomVideoUI(video);
    }

    async function setupCustomVideoUI(video) {
      const v = document.getElementById('customVideo');
      const controls = document.getElementById('customControls');
      const playPauseBtn = document.getElementById('playPauseBtn');
      const seekBar = document.getElementById('seekBar');
      const currentTimeSpan = document.getElementById('currentTime');
      const durationSpan = document.getElementById('duration');
      const muteBtn = document.getElementById('muteBtn');
      const errorUI = document.getElementById('videoErrorUI');
      let hasCountedView = false;

      v.onerror = function() {
        controls.style.display = 'none';
        errorUI.style.display = 'flex';
      };
      v.onloadedmetadata = function() {
        controls.style.display = '';
        errorUI.style.display = 'none';
        seekBar.max = v.duration || 1;
        durationSpan.textContent = formatTime(v.duration);
      };
      v.onplay = () => { playPauseBtn.textContent = "‚è∏Ô∏è"; };
      v.onpause = () => { playPauseBtn.textContent = "‚ñ∂Ô∏è"; };
      v.ontimeupdate = () => {
        seekBar.value = v.currentTime;
        currentTimeSpan.textContent = formatTime(v.currentTime);
        // increment view after 3 seconds of watch time, only once per open
        if (!hasCountedView && v.currentTime >= 3) {
          hasCountedView = true;
          fetch(`${API_BASE}videos/${video.id}/view`, { method: 'POST', credentials: 'include' })
            .then(()=>{ document.getElementById('viewCount').textContent = (parseInt(document.getElementById('viewCount').textContent)+1); });
        }
      };
      seekBar.oninput = () => {
        v.currentTime = seekBar.value;
        currentTimeSpan.textContent = formatTime(v.currentTime);
      };
      playPauseBtn.onclick = () => { if (v.paused) v.play(); else v.pause(); };
      muteBtn.onclick = () => {
        v.muted = !v.muted;
        muteBtn.textContent = v.muted ? "üîá" : "üîä";
      };
      v.onkeydown = e => { if (e.code === "Space") { e.preventDefault(); playPauseBtn.click(); } };
      setTimeout(() => { if (v.readyState === 0) { controls.style.display = 'none'; errorUI.style.display = 'flex'; } }, 500);
      setTimeout(() => { if (v.paused) v.play().catch(()=>{}); }, 200);

      // Like/Dislike logic
      const likeBtn = document.getElementById('likeBtn');
      const dislikeBtn = document.getElementById('dislikeBtn');
      const likeCount = document.getElementById('likeCount');
      const dislikeCount = document.getElementById('dislikeCount');

      // Set current reaction for this user
      let liked = false, disliked = false;
      try {
        const reactionRes = await fetch(`${API_BASE}videos/${video.id}/reaction`, { credentials: 'include' });
        const reaction = await reactionRes.json();
        liked = !!reaction.liked;
        disliked = !!reaction.disliked;
        if (liked) likeBtn.classList.add('liked'); else likeBtn.classList.remove('liked');
        if (disliked) dislikeBtn.classList.add('disliked'); else dislikeBtn.classList.remove('disliked');
      } catch {}

      likeBtn.onclick = async () => {
        const res = await fetch(`${API_BASE}videos/${video.id}/like`, { method: 'POST', credentials: 'include' });
        const result = await res.json();
        liked = result.liked;
        disliked = result.disliked;
        if (liked) {
          likeBtn.classList.add('liked');
          if (parseInt(likeCount.textContent) === 0) likeCount.textContent = 1;
          else likeCount.textContent = parseInt(likeCount.textContent) + 1;
          if (disliked) {
            dislikeBtn.classList.remove('disliked');
            if (parseInt(dislikeCount.textContent) > 0) dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
          }
        } else {
          likeBtn.classList.remove('liked');
          if (parseInt(likeCount.textContent) > 0) likeCount.textContent = parseInt(likeCount.textContent) - 1;
        }
      };
      dislikeBtn.onclick = async () => {
        const res = await fetch(`${API_BASE}videos/${video.id}/dislike`, { method: 'POST', credentials: 'include' });
        const result = await res.json();
        liked = result.liked;
        disliked = result.disliked;
        if (disliked) {
          dislikeBtn.classList.add('disliked');
          if (parseInt(dislikeCount.textContent) === 0) dislikeCount.textContent = 1;
          else dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
          if (liked) {
            likeBtn.classList.remove('liked');
            if (parseInt(likeCount.textContent) > 0) likeCount.textContent = parseInt(likeCount.textContent) - 1;
          }
        } else {
          dislikeBtn.classList.remove('disliked');
          if (parseInt(dislikeCount.textContent) > 0) dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
        }
      };
    }
    function closeVideoModal() {
      document.getElementById('videoModal').style.display = 'none';
      document.getElementById('videoModal').innerHTML = '';
    }
    window.closeVideoModal = closeVideoModal;
  </script>
</body>
</html>